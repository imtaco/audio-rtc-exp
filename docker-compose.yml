services:

  etcd-store:
    image: quay.io/coreos/etcd:v3.5.15
    container_name: etcd-store
    networks: ["janus"]
    environment:
      - ALLOW_NONE_AUTHENTICATION=yes
      - ETCD_LISTEN_CLIENT_URLS=http://0.0.0.0:2379
      - ETCD_ADVERTISE_CLIENT_URLS=http://etcd-store:2379
      - ETCD_DATA_DIR=/data
    ports:
      - "2379:2379"
    volumes:
      - etcddata:/data

  redis:
    image: redis:8.4-alpine3.22
    container_name: redis
    networks: ["janus"]
    ports:
      - "6379:6379"

  janus:
    image: canyan/janus-gateway:latest
    container_name: janus
    networks: ["janus"]
    ports:
      # - "8188:8188" # ws
      - "8088:8088" # rest
      - "20000-20200:20000-20200/udp"
    volumes:
      - ./janus/janus.jcfg:/usr/local/etc/janus/janus.jcfg
      - ./janus/janus.transport.websockets.jcfg:/usr/local/etc/janus/janus.transport.websockets.jcfg
      - ./janus/janus.plugin.audiobridge.jcfg:/usr/local/etc/janus/janus.plugin.audiobridge.jcfg
    restart: always

  # docker build --output type=local,dest=./dist -f Dockerfile.build .
  frontend:
    build:
      context: .
      dockerfile: frontend/Dockerfile
    container_name: frontend
    working_dir: /workspace/frontend
    networks: ["janus"]
    ports:
      - "5173:5173"
    # command: ["tail", "-f", "/dev/null"]
    # command: ["yarn", "dev"]
    volumes:
      # Development hot-reload (optional, comment out for production)
      - ./frontend:/workspace/frontend
      - ./shared:/workspace/shared
    restart: always

  playground:
    image: golang-dev
    container_name: playground
    networks: ["janus"]
    ports:
      - "8086:8086"
      - "8087:8087"
    environment:
      - ETCD_ENDPOINTS=etcd-store:2379
      # - LOG_LEVEL_USER_SRV=debug
      # - LOG_LEVEL_REDIS_RPC=debug
      # - LOG_LEVEL_REDIS_STREAM=debug
    volumes:
      # Development hot-reload (optional, comment out for production)
      - ./backend:/src
    depends_on:
      # - etcd-store
      - redis
    command: ["tail", "-f", "/dev/null"]
    restart: always

  room-manager:
    image: golang-dev
    container_name: room-manager
    networks: ["janus"]
    ports:
      - "3000:3000"
    volumes:
      # Development hot-reload (optional, comment out for production)
      - ./backend:/src
    environment:
      - ETCD_ENDPOINTS=etcd-store:2379
      - HTTP_ADDR=:3000
      - LOG_LEVEL=debug
    depends_on:
      - janus
      - etcd-store
      - mixer1
    working_dir: /src/rooms/cmd
    command: ["go", "run", "main.go"]
    # command: ["tail", "-f", "/dev/null"]
    restart: always

  aes-server:
    image: golang-dev
    container_name: aes-server
    networks: ["janus"]
    ports:
      - "3100:3100" # token server
      - "3101:3101" # key server
    volumes:
      # Development hot-reload (optional, comment out for production)
      - ./backend:/src
    environment:
      - ETCD_ENDPOINTS=etcd-store:2379
      - TOKEN_SERVER_HTTP_ADDR=:3100
      - KEY_SERVER_HTTP_ADDR=:3101
      - JWT_SECRET=anothersecret
      - LOG_LEVEL=debug
    depends_on:
      - janus
      - etcd-store
      - mixer1
    working_dir: /src/hlsserver/cmd
    command: ["go", "run", "main.go"]
    # command: ["tail", "-f", "/dev/null"]
    restart: always

  mixer1:
    image: golang-dev
    container_name: mixer1
    networks: ["janus"]
    environment:
      - ETCD_ENDPOINTS=etcd-store:2379
      - JANUS_URL=ws://janus:8188/
      - ADMIN_SECRET=supersecret
      - LOG_LEVEL_USER=debug
      # - LOG_LEVEL_USER_SRV=debug
      # - LOG_LEVEL_REDIS_RPC=debug
      # - LOG_LEVEL_REDIS_STREAM=debug
    volumes:
      - ./hls:/hls
      # Development hot-reload (optional, comment out for production)
      - ./backend:/src
    depends_on:
      - etcd-store
      # - redis
    working_dir: /src/mixers/cmd
    command: ["go", "run", "main.go"]
    # command: ["tail", "-f", "/dev/null"]
    restart: always

  janus-manager:
    image: golang-dev
    container_name: janus-manager
    networks: ["janus"]
    environment:
      - ETCD_ENDPOINTS=etcd-store:2379
      - HTTP_ADDR=:8081
      - JANUS_ADV_HOST=janus
      - JANUS_ADV_PORT=8088
      - JANUS_URL=ws://janus:8188/
      - ADMIN_SECRET=supersecret
      - LOG_LEVEL_USER=debug
    volumes:
      - ./hls:/hls
      # Development hot-reload (optional, comment out for production)
      - ./backend:/src
    depends_on:
      - etcd-store
      # - redis
    working_dir: /src/januses/cmd
    command: ["go", "run", "main.go"]
    # command: ["tail", "-f", "/dev/null"]
    restart: always

  user-service:
    image: golang-dev
    container_name: user-service
    networks: ["janus"]
    ports:
      - "8085:8085"
    volumes:
      # Development hot-reload (optional, comment out for production)
      - ./backend:/src
    environment:
      - ETCD_ENDPOINTS=etcd-store:2379
      - HTTP_ADDR=:8085
      - LOG_LEVEL=debug
    depends_on:
      - redis
    working_dir: /src/users/cmd
    command: ["go", "run", "main.go"]
    # command: ["tail", "-f", "/dev/null"]
    restart: always

  ws-gateway:
    image: golang-dev
    container_name: ws-gateway
    networks: ["janus"]
    ports:
      - "8081:8081"
      - "8082:8082"
      - "8083:8083"
    volumes:
      # Development hot-reload (optional, comment out for production)
      - ./backend:/src
    environment:
      - ETCD_ENDPOINTS=etcd-store:2379
      - JANUS_URL=ws://janus:8188/
      - ADMIN_SECRET=supersecret
      - WS_ADDR=:8081
      - LOG_LEVEL=debug
      # - LOG_LEVEL_USER_SRV=debug
      # - LOG_LEVEL_REDIS_RPC=debug
      # - LOG_LEVEL_REDIS_STREAM=debug
    depends_on:
      - etcd-store
      - redis
    working_dir: /src/wsgateway/cmd
    command: ["go", "run", "main.go"]
    # command: ["tail", "-f", "/dev/null"]
    restart: always

  web-server:
    image: nginx:1.28-alpine
    container_name: web-server
    networks: ["janus"]
    ports:
      - "8080:80"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./hls:/wwwroot/hls
      - ./fs/sounds:/wwwroot/sounds
    restart: always

volumes:
  etcddata:

networks:
  janus:
    driver: bridge
